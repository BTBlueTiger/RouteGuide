name: Ubuntu Build

on: [push]

jobs:
  ubuntu:
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: '⚙️ Install dependencies'
      run: |
        sudo apt-get update
        sudo apt install qtbase5-dev
        sudo apt install desktop-file-utils libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 libxcb-xinerama0 libxcb-composite0 libxcb-cursor0 libxcb-damage0 libxcb-dpms0 libxcb-dri2-0 libxcb-dri3-0 libxcb-ewmh2 libxcb-glx0 libxcb-present0 libxcb-randr0 libxcb-record0 libxcb-render0 libxcb-res0 libxcb-screensaver0 libxcb-shape0 libxcb-shm0 libxcb-sync1 libxcb-util1 libxkbcommon-x11-0
        sudo apt install ninja-build

    - name: Install Qt for Linux
      uses: jurplel/install-qt-action@v4
      with:
        aqtversion: '==3.1.*'
        version: '6.7.0'
        host: 'linux'
        target: 'desktop'
        arch: 'linux_gcc_64'
        modules: 'qtpositioning qtlocation qtconnectivity qtimageformats qtsensors qt5compat'
        cache: "true"

    - name: Build
      run: cmake -S ./frontend -B build -G "Ninja Multi-Config" && cmake --build build --config Debug
    
    - name: install libfuse
      run: sudo apt-get install -y libfuse2
    
    - name: AppImage
      run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-plugin-qt-x86_64.AppImage
          export PATH=${{ github.workspace }}/Qt/6.7.0/gcc_64/libexec:$PATH
          export EXTRA_QT_PLUGINS="svg;"
          cp ./frontend/res/img/logo.jpeg RouteGuide.jpeg 
          ./linuxdeploy-x86_64.AppImage --appdir build/Debug --plugin qt
          mkdir -p ${{env.BUILD_DIR}}/usr/languages && cp -r languages/*.qm ${{env.BUILD_DIR}}/usr/languages
          ./linuxdeploy-x86_64.AppImage --appdir build/Debug --output appimage

    - name: Upload build artifacts
      uses: actions/upload-artifact@v2
      with:
        name: build-artifacts
        path: build/Debug/
